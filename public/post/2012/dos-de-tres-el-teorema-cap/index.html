<!DOCTYPE html>
<html lang="es-cl" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Dos de Tres: El Teorema CAP | La Naturaleza del Software</title>
<link rel="icon" href="/favicon.svg" sizes="any" type="image/svg+xml" /><meta property="og:url" content="http://localhost:1313/post/2012/dos-de-tres-el-teorema-cap/">
  <meta property="og:site_name" content="La Naturaleza del Software">
  <meta property="og:title" content="Dos de Tres: El Teorema CAP">
  <meta property="og:description" content="Mi amiga ISA reclama por sus papitas, se refiere a un problema que tuvo al tratar de adquirir objetos con su tarjeta de crédito para un juego online. Este es un problema común, lo que todos esperamos es que si el dinero ha sido descontado de nuestra tarjeta de crédito nos llegue el producto que compramos, más aún si se trata de un objeto virtual (después de todo se trata de mover bytes de un registro a otro, ¿no?).">
  <meta property="og:locale" content="es_cl">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2012-05-25T08:25:11-03:00">
    <meta property="article:modified_time" content="2012-05-25T08:25:11-03:00">
    <meta property="article:tag" content="Teorema Cap">
    <meta property="article:tag" content="Consistencia">
    <meta property="article:tag" content="Disponibilidad">
    <meta property="article:tag" content="Arquitectura">
    <meta property="article:tag" content="Sistemas Distribuidios">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Dos de Tres: El Teorema CAP">
  <meta name="twitter:description" content="Mi amiga ISA reclama por sus papitas, se refiere a un problema que tuvo al tratar de adquirir objetos con su tarjeta de crédito para un juego online. Este es un problema común, lo que todos esperamos es que si el dinero ha sido descontado de nuestra tarjeta de crédito nos llegue el producto que compramos, más aún si se trata de un objeto virtual (después de todo se trata de mover bytes de un registro a otro, ¿no?).">

    <link rel="stylesheet" href="/css/root.css">
    <link rel="stylesheet" href="/css/bundle.css">

      <script src="/js/bundle.js"></script><script defer src="/js/search/flexsearch.compact.64594b125f7b78bdf4fa8316955922bbebb1cd6baef3f16654bfca20309f18f8.js" integrity="sha256-ZFlLEl97eL30&#43;oMWlVkiu&#43;uxzWuu8/FmVL/KIDCfGPg="></script>
<script defer src="/js/search/search.1d980f84df11f3eb7c8c5f17f541d49a0611608df179dd74fa7f06225eb56ace.js" integrity="sha256-HZgPhN8R8&#43;t8jF8X9UHUmgYRYI3xed10&#43;n8GIl61as4="></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">

</head>
<body class="notransition">
  <div id="container">
    <header id="main-header"><div role="navigation" aria-label="Main">
  <div class="nav-left">
    <a href="http://localhost:1313/" style="color: inherit;">La Naturaleza del Software</a>
  </div>
  <div class="nav-right">
    <div style="position:absolute;width:0px;height:0px;">
      <div id="nav-dropdown-menu" class="hidden" href="#">
    <div class="nav-item">
      <a
      >Posts</a>
    </div>
</div>
    </div>
    <a id="nav-dropdown-button" href="#"><svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
    <div id="nav-menu">
    <div class="nav-item">
      <a
      >Posts</a>
    </div>
</div>
    <a id="theme-switcher" href="#">
<svg class="light-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12 3V4M12 20V21M4 12H3M6.31412 6.31412L5.5 5.5M17.6859 6.31412L18.5 5.5M6.31412 17.69L5.5 18.5001M17.6859 17.69L18.5 18.5001M21 12H20M16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>

<svg class="dark-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M3.32031 11.6835C3.32031 16.6541 7.34975 20.6835 12.3203 20.6835C16.1075 20.6835 19.3483 18.3443 20.6768 15.032C19.6402 15.4486 18.5059 15.6834 17.3203 15.6834C12.3497 15.6834 8.32031 11.654 8.32031 6.68342C8.32031 5.50338 8.55165 4.36259 8.96453 3.32996C5.65605 4.66028 3.32031 7.89912 3.32031 11.6835Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
  </div>
</div>
</header>
    <div class="flex grow">
      <div id="main-pane">
        <main id="main-content"><div class="single-header">
<ol class="breadcrumbs" itemscope itemtype="https://schema.org/BreadcrumbList">
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="http://localhost:1313/">
        <span itemprop="name">Home</span>
      </a>
      <meta itemprop="position" content='1' />
    </li>
    <span>&nbsp»&nbsp</span>
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="http://localhost:1313/post/">
        <span itemprop="name">Posts</span>
      </a>
      <meta itemprop="position" content='2' />
    </li>
    <span>&nbsp»&nbsp</span>
</ol>
<h1>Dos de Tres: El Teorema CAP</h1><time class="dim" datetime="2012-05-25T08:25:11-03:00">May 25, 2012</time><div class="term-container"><div class="tag">
        <a href="http://localhost:1313/tags/teorema-cap/">#teorema cap</a>
      </div><div class="tag">
        <a href="http://localhost:1313/tags/consistencia/">#consistencia</a>
      </div><div class="tag">
        <a href="http://localhost:1313/tags/disponibilidad/">#disponibilidad</a>
      </div><div class="tag">
        <a href="http://localhost:1313/tags/arquitectura/">#arquitectura</a>
      </div><div class="tag">
        <a href="http://localhost:1313/tags/sistemas-distribuidios/">#sistemas distribuidios</a>
      </div></ol></div>
  <section class="page-section"><p>Mi amiga ISA <a href="https://idelabar.blogspot.com/2012/04/quiero-mis-papitas-d.html">reclama por sus papitas</a>,
se refiere a un problema que tuvo al tratar de adquirir objetos con su
tarjeta de crédito para un juego online. Este es un problema común, lo
que todos esperamos es que si el dinero ha sido descontado de nuestra
tarjeta de crédito nos llegue el producto que compramos, más aún si se
trata de un objeto virtual (después de todo se trata de mover bytes de
un registro a otro, ¿no?).</p>
<p>Si hay fondos en la cuenta, y el servidor de medio de pago ha dado la
autorización esperamos que nuestros bienes lleguen a nosotros, o los
servicios que pagamos estén disponibles. O cuando pagamos una cuenta en
linea, esperamos que todo esté acreditado y no tengamos problemas
posteriores.</p>
<p>En <a href="https://idelabar.blogspot.com/2012/04/quiero-mis-papitas-d.html">su artículo</a>
Isabel menciona  las propiedades que deben cumplir las bases de datos
transaccionales, el famoso acrónimo ACID: Atomicity (Atomicidad),
Consistency (Consistencia), Isolation (Aislamiento) y Durability
(Durabilidad). Estas propiedades son deseables, y se espera que un motor
de bases de datos transaccionales las respete. Isabel dice que &quot;algunas
de estas caracteristicas las entrega la base de datos y otras es parte
responsabilidad de quienes desarrollan la transacción.&quot;</p>
<p>El problema es que implementar sistemas que respeten estas propiedades
en sistemas distribuidos ¡es muy difícil! Es más, existe un importante
resultado que nos dice que en sistemas distribuidos hacer esto requiere
ciertos compromisos. Ese resultado es conocido como el
<a href="https://en.wikipedia.org/wiki/CAP_Theorem">Teorema CAP</a>, y sospecho que no muchos
de ustedes lo conocen, y si se dedican a la arquitectura de sistemas
deberían.</p>
<h1 id="el-teorema-cap">El Teorema CAP</h1>
<p>El 19 de julio de 2000 el profesor <a href="https://www.cs.berkeley.edu/~brewer/">Eric Brewer</a>,
planteó una conjetura en
base a su trabajo implementando Inktomi.</p>
<p><img src="Inktomi.png" alt=""></p>
<p>Inktomi era la gran promesa de ese tiempo, se consideraba que sería el
buscador que terminaría desplazando a  AltaVista, bueno, eso fue antes
de Google, y que reventara la burbuja de las .com. Lo importante es que
Brewer aprendió mucho implementando este servicio, y en un simposio de
la ACM planteó la siguiente conjetura:</p>
<blockquote>
<p>Es imposible para un sistema distribuido garantizar simultáneamente
las siguientes tres características:</p></blockquote>
<blockquote>
<ul>
<li>
<p>Consistency (Consistencia): todos los nodos ven la misma data al
mismo tiempo.</p>
</li>
<li>
<p>Availability (Disponibilidad): una garantía de que todos los
requerimientos recibirán una respuesta de que el requerimiento fue
exitoso o fallido.</p>
</li>
<li>
<p>Partition Tolerance (Tolerancia a la Partición): el sistema
continúa operando a pesar de la pérdida arbitraria de mensajes, o
la falla de parte del sistema.</p>
</li>
</ul></blockquote>
<p>Dos años más tarde Seth Gilbert y Nancy Lynch del MIT publicaron
<a href="https://lpd.epfl.ch/sgilbert/pubs/BrewersConjecture-SigAct.pdf">una demostración</a>
de la conjetura de Brewer, estableciéndolo como un teorema,
probablemente uno de los teoremas más importantes de las ciencias de la
computación, y uno de gran importancia para todos los que nos dedicamos
a la arquitectura de software.</p>
<p>El Teorema CAP dice que puedes garantizar dos de tres de estas
propiedades. Es decir, el teorema CAP explica porque Isabel tuvo que
esperar por sus papitas más tiempo del que ella esperaba, o simplemente
puede que no les haya recibido. Explica porque a veces aunque tratamos
de diseñar nuestro sistema de la forma más robusta posible hay algo que
vamos a perder.</p>
<p>Si ustedes tratan de diseñar su arquitectura para tener full
consistencia, full disponibilidad y una total tolerancia a fallos,
entonces están perdiendo su tiempo, es imposible. En algún momento algo
se va a romper, una transacción se va a perder, o un registro quedará
inconsistente, no pueden tener las tres propiedades garantizadas, deben
elegir dos.</p>
<p>Como la demostración del teorema es muy técnica, voy a explicarles en
términos simples usando
<a href="https://ksat.me/a-plain-english-introduction-to-cap-theorem/">un bonito ejemplo</a>
escrito por Kaushik Sathupadi.</p>
<h3 id="capítulo-1-un-nuevo-emprendimiento"><strong>Capítulo 1: Un nuevo emprendimiento</strong></h3>
<p>Una noche cuando tu esposa agradece que te acuerdes de vuestra fecha de
aniversario de matrimonio, te viene a la cabeza una idea curiosa. Muchas
personas tienen problemas para recordar las cosas, y sin embargo tu no
tienes es problema, porque eres muy bueno recordando, entonces decides
crear tu propia startup: Recuerdos Inc.</p>
<p>Escribes tu anuncio en el diario:</p>
<blockquote>
<p><em>Recuerdos Inc: Nunca olvide, ¡sin necesidad de recordar! ¿Se ha
sentido mal por olvidar demasiado? No se preocupe, simplemente
llámenos, marque el 555-RECUERDE y díganos lo que necesita recordar
después.  ¿No recuerda la fecha de cumpleaños de su jefe? llame al
555-RECUERDE y se la recordaremos. No olvide más, no necesita recordar
nada, nosotros recordamos por usted. (Costo $ 290, IVA incluido)</em></p>
<p>Y contratas una linea telefónica, te compras unos cuadernos y empiezas
a atender. Un diálogo en tu servicio sería más o menos así:</p></blockquote>
<blockquote>
<ul>
<li>
<p>Cliente: Hola, ¿podría guardar la fecha de cumpleaños de mi
vecino?</p>
</li>
<li>
<p>Tú: Claro, ¿cuando es?</p>
</li>
<li>
<p>Cliente: el 4 de mayo</p>
</li>
<li>
<p>Tú: (anotas la fecha en la página del cliente en un cuaderno)
¡Anotado! Llámenos cuando necesite saber el cumpleaños de su
vecino</p>
</li>
<li>
<p>Cliente: ¡Gracias!</p>
</li>
<li>
<p>Tú: De nada, esta llamada tiene un costo de $290 el minuto,
gracias por llamar.</p>
</li>
</ul></blockquote>
<h3 id="capítulo-2-empiezas-a-escalar"><strong>Capítulo 2: empiezas a escalar</strong></h3>
<p>Consigues algo de capital de riesgo, y empiezas a recibir cientos de
llamadas al día. Y junto con esto empiezan los problemas, las  llamadas
se empiezan a encolar, la gente cuelga el teléfono después de esperar
tanto rato. Y para colmo un día te enfermas y pierdes todo un día de
atención. Así que decides escalar, le pides a tu mujer que te apoye y se
incorpore al servicio. Compras una central telefónica, colocas un anexo
para tu esposa y duplicas tu capacidad de atención (¡y duplicas tus
ingresos!)</p>
<h3 id="capítulo-3-tu-servicio-es-malo"><strong>Capítulo 3: tu servicio es malo</strong></h3>
<p>Es miércoles y recibes una llamada de tu mejor cliente Juan:</p>
<blockquote>
<ul>
<li>
<p>Juan: Hola</p>
</li>
<li>
<p>Tú: Buenas tardes señor, gracias por llamar a Recuerdo Inc. ¿en
que podemos servirle?</p>
</li>
<li>
<p>Juan: ¿Puede decirme cuando es mi viaje a Puerto Montt?</p>
</li>
<li>
<p>Tú: Un segundo por favor (buscas en tu cuaderno, ¡y no hay ningún
vuelo anotado en la página de Juan!) Señor, creo que hay un error,
usted no nos ha dicho nada sobre un viaje a Puerto Montt.</p>
</li>
<li>
<p>Juan: ¡Qué! ¡Si yo los llamé ayer! (y cuelga)</p>
</li>
</ul></blockquote>
<p>Conversas con tu esposa y te das cuenta que ella atendió a Juan ayer,
pero el vuelo está anotado en el cuaderno de ella, y no en el tuyo.
**¡Tu sistema distribuido no es consistente! **Un cliente puede ser
atendido por tu esposa, y cuando llame de nuevo puede ser redirigido a
otra persona, y Recuerdos Inc. ¡no tendrá una respuesta consistente para
el cliente!</p>
<h3 id="capítulo-4-arreglas-el-problema-de-consistencia"><strong>Capítulo 4: arreglas el problema de consistencia</strong></h3>
<p>Conversas con tu esposa y le dices:</p>
<blockquote>
<ul>
<li>
<p>Siempre que recibamos una llamada de un cliente antes de completar
la llamada le avisaremos al otro.</p>
</li>
<li>
<p>En ese momento ambos anotaremos el recordatorio.</p>
</li>
<li>
<p>De este modo ambos tendremos copia de los recuerdos y no tendremos
que ir a leer el cuaderno del otro.</p>
</li>
</ul></blockquote>
<p>Esto implica que cuando  se tenga que actualizar el cuaderno no podremos
atender a nadie. Eso no es un gran problema porque la mayor parte de las
veces los requerimiento son de consultas que implican buscar algo en los
cuadernos, más que escribir. Además lo importante es que no podemos dar
respuestas incorrectas, así que este es un costo que debemos asumir.</p>
<p>Pero tu mujer te hace notar que no has considerado el caso cuando uno de
los dos no se presenta a trabajar. En ese momento no es posible atender
una conversación de actualización, porque no está disponible el otro
para copiar a su cuaderno. Estamos ante un problema de
<strong>disponibilidad</strong>, si el otro no está, ¡no es posible completar la
llamada!</p>
<h2 id="capítulo-5-una-solución-astuta"><strong>Capítulo 5: una solución astuta</strong></h2>
<p>¿Cómo logras que las anotaciones en los cuadernos queden consistentes y
disponibles, ante la ausencia de uno de los dos? Para resolver esto se
te ocurre  una idea brillante, y se la dices a tu pareja:</p>
<blockquote>
<ul>
<li>
<p>Cuando una persona llame para ingresar un recuerdo, es decir,
cuando se requiera escribir algo en los cuadernos, lo que haremos
es que si está la otra persona disponible entonces le avisaremos
en ese momento y ambos actualizarán sus apuntes.</p>
</li>
<li>
<p>Si la otra persona no está disponible, entonces le enviaremos un
email con la actualización.</p>
</li>
<li>
<p>Al otro día, cuando la persona que estuvo ausente regrese lo
primero que debe hacer es leer sus emails y actualizar su cuaderno
antes de poder empezar a atender el teléfono.</p>
</li>
</ul></blockquote>
<p>Genial! Ahora Recuerdos Inc. tiene un servicio <strong>consistente</strong> y de
<strong>alta disponibilidad</strong>.</p>
<h3 id="capítulo-6-tu-mujer-está-enojada-contigo"><strong>Capítulo 6: tu mujer está enojada contigo</strong></h3>
<blockquote>
<p>Pero un día discutes con tu mujer, y estás tan molesto que decides
salir y presentarte a trabajar. ¿Qué tal si ella está tan enojada
contigo que decide no actualizarte de nada y no manda los emails
acordados?. Tu genial idea fracasa, porque a pesar de que es una idea
astuta que garantiza consistencia y alta disponibilidad no es
<strong>tolerante a una partición</strong>. Puedes decidir ser tolerante a fallos
tomando la decisión de no atender llamados hasta que te hayas
reconciliado con tu mujer, pero si haces eso entonces ¡<strong>sacrificas la
disponibilidad</strong> durante todo ese tiempo!.</p></blockquote>
<h3 id="conclusión"><strong>Conclusión</strong></h3>
<blockquote>
<p>Así que el teorema CAP nos dice que cuando diseñas un sistema no
puedes tener las tres características: Consistencia, Disponibilidad o
Tolerancia a Particiones. Sólo puedes elegir dos:</p></blockquote>
<blockquote>
<ul>
<li>
<p>Consistencia: tus clientes, una vez que han actualizado
información siempre tendrán la información más actualizad cuando
llamen nuevamente. No importa que tan rápido vuelvan a llamar.</p>
</li>
<li>
<p>Disponibilidad: Recuerdos Inc siempre estará disponible para
llamadas mientras cualquiera de ustedes (tú o tu esposa) se
presente a trabajar.</p>
</li>
<li>
<p>Tolerancia a Partición: Recuerdos Inc operará siempre, aunque se
haya perdido la comunicación entre tú y tu esposa</p>
</li>
</ul></blockquote>
<h2 id="consistencia-eventual">Consistencia Eventual</h2>
<p>¿Qué pasaría si contrataras a un ayudante que se encargue de actualizar
los cuadernos cada vez que hay un cambio?. Este personaje puede
actualizar los cuadernos en &quot;background&quot;, mientras no se ocupan, su
labor es mantener consistente las anotaciones, claro que con un cierto
retraso. La base no se encuentra consistente de inmediato, pero con esto
no sacrificas la disponibilidad, a cambio de un cierto grado de
inconsistencia temporal.</p>
<p>Así es como funcionan muchas bases de datos NoSQL, por ejemplo. Lo
importante es que el ayudante haga su trabajo con cierta celeridad, si
realiza su labor digamos que cada 5 minutos, entonces reduces las
probabilidades de que te encuentres con inconsistencias.</p>
<p>Por lo tanto debemos aceptar que no podemos controlar todas las
situaciones y hay veces que nuestras arquitecturas van a fallar. Podemos
diseñarlas para maximizar estas tres propiedades, pero eventualmente
algo deberemos sacrificar. La pregunta es qué. ¿La disponibilidad por la
consistencia, o la consistencia por la disponibilidad? Ese es el
desafío, y buscar medidas de mitigación es nuestra labor como
arquitectos. Pero no olviden, que habrá ocasiones en que simplemente
tendremos que devolver el dinero, o pedir disculpas, eso es seguro,
tenemos un teorema que lo demuestra. :)</p>
</section></main>
        <footer id="main-footer"><div class="footer">
  <a href="#">Scroll to Top</a>
  <div class="footer-copyright">
    <div class="dim">© 2025 </div>
    <div>Made with ❤️ and powered by <a href="https://github.com/math-queiroz/rusty-typewriter" target="_blank">Rusty Typewriter</a> theme for <a href="https://gohugo.io/" target="_blank">Hugo</a></div>
  </div>
</div>
</footer>
      </div><aside id="side-pane" class="side-sticky"><div class="side-details">
    <span>1769 words</span>
    <span>10 - 13 minutes read</span></div><h3>Table Of Contents</h3><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#capítulo-1-un-nuevo-emprendimiento"><strong>Capítulo 1: Un nuevo emprendimiento</strong></a></li>
        <li><a href="#capítulo-2-empiezas-a-escalar"><strong>Capítulo 2: empiezas a escalar</strong></a></li>
        <li><a href="#capítulo-3-tu-servicio-es-malo"><strong>Capítulo 3: tu servicio es malo</strong></a></li>
        <li><a href="#capítulo-4-arreglas-el-problema-de-consistencia"><strong>Capítulo 4: arreglas el problema de consistencia</strong></a></li>
      </ul>
    </li>
    <li><a href="#capítulo-5-una-solución-astuta"><strong>Capítulo 5: una solución astuta</strong></a>
      <ul>
        <li><a href="#capítulo-6-tu-mujer-está-enojada-contigo"><strong>Capítulo 6: tu mujer está enojada contigo</strong></a></li>
        <li><a href="#conclusión"><strong>Conclusión</strong></a></li>
      </ul>
    </li>
    <li><a href="#consistencia-eventual">Consistencia Eventual</a></li>
  </ul>
</nav><h3>Attachments</h3>
    <ul><li><a href="http://localhost:1313/post/2012/dos-de-tres-el-teorema-cap/Inktomi.png">Inktomi.png</a></li></ul><h3>Related</h3>
    <ul><li><a href="/post/2011/que-es-una-arquitectura/">¿Qué es una arquitectura?</a></li></ul></aside></div>
  </div>
</body>
</html>
